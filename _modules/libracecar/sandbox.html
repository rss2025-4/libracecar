<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>libracecar.sandbox &#8212; libracecar  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for libracecar.sandbox</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">ROS uses network to communicate between nodes, in a distributed fashion.</span>

<span class="sd">This module aims to run some ros nodes in an isolated fasion. It makes sure:</span>

<span class="sd">1) isolated ros nodes does not see nodes running outside isolation</span>

<span class="sd">2) isloated ros nodes are always killed when we finish</span>

<span class="sd">This modules uses linux namespaces to do isolation;</span>
<span class="sd">You can read more about that `here &lt;https://thomasvanlaere.com/posts/2020/12/exploring-containers-part-3/&gt;`_</span>
<span class="sd">(disclaimer: found on google, didnt read myself)</span>

<span class="sd">the main entrypoint of the module is ``isolate``.</span>
<span class="sd">Here is an example of running bash under isolate:</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    import subprocess</span>
<span class="sd">    from libracecar.sandbox import isolate</span>

<span class="sd">    @isolate</span>
<span class="sd">    def main():</span>
<span class="sd">        subprocess.run(&quot;bash -i&quot;, shell=True, check=True)</span>
<span class="sd">        return &quot;finished!&quot;</span>

<span class="sd">    if __name__ == &quot;__main__&quot;:</span>
<span class="sd">        assert main() == &quot;finished!&quot;</span>

<span class="sd">if you run ``ros2 topic list`` under this bash session,</span>
<span class="sd">you will find that nodes outside isolation is not visible.</span>

<span class="sd">here is a more complete example:</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    import subprocess</span>
<span class="sd">    import time</span>

<span class="sd">    from libracecar.sandbox import isolate</span>
<span class="sd">    from libracecar.test_utils import proc_manager</span>


<span class="sd">    # indicate success with an exception</span>
<span class="sd">    class _ok(BaseException):</span>
<span class="sd">        pass</span>


<span class="sd">    def wait_time():</span>
<span class="sd">        time.sleep(5)</span>
<span class="sd">        raise _ok()</span>


<span class="sd">    @isolate</span>
<span class="sd">    def main():</span>
<span class="sd">        procs = proc_manager.new()</span>

<span class="sd">        # run some stuff</span>
<span class="sd">        procs.popen([&quot;rviz2&quot;])</span>
<span class="sd">        procs.ros_launch(&quot;racecar_simulator&quot;, &quot;simulate.launch.xml&quot;)</span>
<span class="sd">        procs.thread(wait_time)</span>

<span class="sd">        # run some gui apps so that you can inspect what is happening in a subshell</span>
<span class="sd">        # only tested with emacs</span>
<span class="sd">        procs.popen([&quot;emacs&quot;])</span>

<span class="sd">        # wait until anything fails/throws, then fail</span>
<span class="sd">        try:</span>
<span class="sd">            procs.spin()</span>
<span class="sd">        except _ok:</span>
<span class="sd">            return &quot;success!&quot;</span>


<span class="sd">    if __name__ == &quot;__main__&quot;:</span>
<span class="sd">        main()</span>

<span class="sd">it appears that pytest can access local varaibles under ``isolate``; i have no idea why this works though.</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    import pytest</span>
<span class="sd">    from libracecar.sandbox import isolate</span>

<span class="sd">    @isolate</span>
<span class="sd">    def test_me(x=2):</span>
<span class="sd">        assert x &lt; 0</span>

<span class="sd">.. code-block:: text</span>

<span class="sd">    ========================================================== FAILURES ==========================================================</span>
<span class="sd">    __________________________________________________________ test_me ___________________________________________________________</span>

<span class="sd">    E   AssertionError: (from &lt;function test_me at 0x7f355e9e0e50&gt; under isolate):</span>
<span class="sd">        assert 2 &lt; 0</span>

<span class="sd">known problems:</span>

<span class="sd">type of exception is not kept; instead an exception with the same name is thrown.</span>

<span class="sd">i have been unable to make this work under github actions</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">ctypes</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ctypes.util</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">functools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Queue</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">queue</span><span class="w"> </span><span class="kn">import</span> <span class="n">Empty</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">ParamSpec</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">unshare</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">better_exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">format_exception</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyroute2</span><span class="w"> </span><span class="kn">import</span> <span class="n">IPRoute</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Never</span>

<span class="n">P</span> <span class="o">=</span> <span class="n">ParamSpec</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">)</span>

<span class="c1"># https://stackoverflow.com/questions/1667257/how-do-i-mount-a-filesystem-using-python</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">CDLL</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_library</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">),</span> <span class="n">use_errno</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">libc</span><span class="o">.</span><span class="n">mount</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">c_char_p</span><span class="p">,</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">c_char_p</span><span class="p">,</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">c_char_p</span><span class="p">,</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">c_ulong</span><span class="p">,</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">c_char_p</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="mount">
<a class="viewcode-back" href="../../libracecar.sandbox.html#libracecar.sandbox.mount">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">mount</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fs</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">target</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">fs</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">errno</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">get_errno</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
            <span class="n">errno</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Error mounting </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">fs</span><span class="si">}</span><span class="s2">) on </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> with options &#39;</span><span class="si">{</span><span class="n">options</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="setup_isolation">
<a class="viewcode-back" href="../../libracecar.sandbox.html#libracecar.sandbox.setup_isolation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">setup_isolation</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">uid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()</span>
    <span class="n">gid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getgid</span><span class="p">()</span>

    <span class="n">unshare</span><span class="o">.</span><span class="n">unshare</span><span class="p">(</span>
        <span class="mi">0</span>
        <span class="o">|</span> <span class="n">unshare</span><span class="o">.</span><span class="n">CLONE_NEWIPC</span>
        <span class="o">|</span> <span class="n">unshare</span><span class="o">.</span><span class="n">CLONE_NEWNET</span>
        <span class="o">|</span> <span class="n">unshare</span><span class="o">.</span><span class="n">CLONE_NEWNS</span>
        <span class="o">|</span> <span class="n">unshare</span><span class="o">.</span><span class="n">CLONE_NEWPID</span>
        <span class="o">|</span> <span class="n">unshare</span><span class="o">.</span><span class="n">CLONE_NEWUSER</span>
    <span class="p">)</span>

    <span class="c1"># Path(&quot;/proc/self/uid_map&quot;).write_text(f&quot;{uid} {uid} 1\n&quot;)</span>
    <span class="c1"># Path(&quot;/proc/self/setgroups&quot;).write_text(f&quot;deny&quot;)</span>
    <span class="c1"># Path(&quot;/proc/self/gid_map&quot;).write_text(f&quot;{gid} {gid} 1\n&quot;)</span>

    <span class="n">mount</span><span class="p">(</span><span class="s2">&quot;tmpfs&quot;</span><span class="p">,</span> <span class="s2">&quot;/dev/shm&quot;</span><span class="p">,</span> <span class="s2">&quot;tmpfs&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">ip</span> <span class="o">=</span> <span class="n">IPRoute</span><span class="p">()</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">link_lookup</span><span class="p">(</span><span class="n">ifname</span><span class="o">=</span><span class="s2">&quot;lo&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idxs</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">ip</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="s2">&quot;set&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">state</span><span class="o">=</span><span class="s2">&quot;up&quot;</span><span class="p">)</span></div>



<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">_subproc_ret_ok</span><span class="p">:</span>
    <span class="n">val</span><span class="p">:</span> <span class="n">Any</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">_subproc_err</span><span class="p">:</span>
    <span class="n">_tp</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">]</span>
    <span class="n">_str</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_close_queue_and_exit</span><span class="p">(</span><span class="n">q</span><span class="p">:</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Never</span><span class="p">:</span>
    <span class="n">q</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">q</span><span class="o">.</span><span class="n">join_thread</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>


<span class="n">_global_q</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Queue</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="throw">
<a class="viewcode-back" href="../../libracecar.sandbox.html#libracecar.sandbox.throw">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">throw</span><span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="ne">BaseException</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Never</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">_global_q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">_throw</span><span class="p">(</span><span class="n">_global_q</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_throw</span><span class="p">(</span><span class="n">q</span><span class="p">:</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="ne">BaseException</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Never</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># exc_type, exc_value, exc_tb = sys.exc_info()</span>
        <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_tb</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span>
        <span class="n">ex_fmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">format_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ex_fmt</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="n">q</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">(</span><span class="n">_subproc_err</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="n">_close_queue_and_exit</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e2</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_run_user_fn: failed during exception handling: </span><span class="si">{</span><span class="n">e2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_run_user_fn</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">],</span> <span class="n">q</span><span class="p">:</span> <span class="n">Queue</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># runs f, pushes at most one value or exceptions to q</span>
    <span class="c1">#</span>
    <span class="c1"># usually:</span>
    <span class="c1">#   exits with 0 if pushed, otherwise nonzero</span>
    <span class="c1"># promises:</span>
    <span class="c1">#   exit 0 imply value pushed</span>

    <span class="c1"># nvidia gpus wants to have the &quot;right&quot; /proc</span>
    <span class="n">mount</span><span class="p">(</span><span class="s2">&quot;proc&quot;</span><span class="p">,</span> <span class="s2">&quot;/proc&quot;</span><span class="p">,</span> <span class="s2">&quot;proc&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">global</span> <span class="n">_global_q</span>
    <span class="n">_global_q</span> <span class="o">=</span> <span class="n">q</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">__tracebackhide__</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">q</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">(</span><span class="n">_subproc_ret_ok</span><span class="p">(</span><span class="n">ans</span><span class="p">))</span>
        <span class="n">_close_queue_and_exit</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">_throw</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_namespace_root</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">],</span> <span class="n">q</span><span class="p">:</span> <span class="n">Queue</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">setup_isolation</span><span class="p">()</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s2">&quot;fork&quot;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_run_user_fn</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">),</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">exitcode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">exitcode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">exitcode</span><span class="p">)</span>
        <span class="n">_throw</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<div class="viewcode-block" id="run_isolated">
<a class="viewcode-back" href="../../libracecar.sandbox.html#libracecar.sandbox.run_isolated">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">run_isolated</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">R</span><span class="p">:</span>
    <span class="c1"># communicating with _namespace_root via Queue can only work via a fork</span>
    <span class="c1"># if we used spawn than Queue is over network which we will disconnect</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s2">&quot;fork&quot;</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_namespace_root</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">),</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e_</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">e_</span>
        <span class="n">p</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">_subproc_err</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;unknown error; exitcode=</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">exitcode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">_subproc_ret_ok</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">val</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">_subproc_err</span><span class="p">)</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">error_t</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="n">error_t</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">_tp</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="n">error_t</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">_tp</span><span class="o">.</span><span class="vm">__module__</span>
    <span class="n">error_t</span><span class="o">.</span><span class="vm">__qualname__</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">_tp</span><span class="o">.</span><span class="vm">__qualname__</span>

    <span class="n">__tracebackhide__</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">raise</span> <span class="n">error_t</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;(from </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2"> under isolate):</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;&gt; &quot;</span> <span class="o">+</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">_str</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="isolate">
<a class="viewcode-back" href="../../libracecar.sandbox.html#libracecar.sandbox.isolate">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">isolate</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    runs ``f`` in its own linux namespace.</span>

<span class="sd">    Propagates return value and exceptions.</span>

<span class="sd">    The return type ``R`` is required to be pickleable.</span>

<span class="sd">    Type of Exception is NOT kept; instead an exception with the same name is thrown.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">inner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">R</span><span class="p">:</span>
        <span class="n">__tracebackhide__</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">run_isolated</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">inner</span><span class="p">,</span> <span class="s2">&quot;__signature__&quot;</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">inner</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">libracecar</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">libracecar</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, rss-2025-team4.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>